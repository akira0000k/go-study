package main

import (
	"fmt"
	//"math/rand"
	"sync"
	//"sync/atomic"
	"time"
	//"errors"
)

/*
 subject: 送信側は複数 and 受信側は複数
 Dispatcher - Worker 的な。
 Dispatcher を独自に用意しているサンプルが散見されますが、型によって受け渡す worker を変えて云々、みたいな分岐が必要なければ channel 自体が dispatcher になります。
 基本的には受信側が増える分には close を使えば問題なし。
*/
const (
	maxreq=1000
	nOnce=33
	workerNum = 10
)

// job queue for worker
type Job struct {
	id uint
	res uint
}

// request array
type Request struct {
	id uint
}
func (r *Request) NewJob() Job {
	var j Job
	j.id = r.id
	j.res = 0
	return j
}
var request []Request


func worker(ww *sync.WaitGroup, queue chan Job, resultChan chan Job) {
	defer ww.Done()
	
	for j := range queue {
		id := j.id
		res := id * 2
		resultChan <-Job{ id, res }
	}
}

func someRequest(from, to uint, queue chan Job) {
	reque := request[from: to]
	for _, r := range reque {
		queue <-r.NewJob()
	}
}

func A(queue chan Job) {
	defer close(queue)
	
	wg := new(sync.WaitGroup)
	for i:=uint(0); ; i++ {
		from := i * nOnce
		if from >= maxreq {
			break
		}
		
		to := (i + 1) * nOnce
		if to >= maxreq {
			to = maxreq - 1
		}

		wg.Add(1)
		go func() {
			defer wg.Done()
			someRequest(from, to, queue)
		}()
	}
	fmt.Println("wait all request.....")
	wg.Wait()
	fmt.Println("......all request done")
}


func makeRequest(n int) {
	for i:=0; i<n; i++ {
		r := Request{ uint(i) }
		request = append(request, r)
	}
}

func main() {
	fmt.Println("start main")
	makeRequest(maxreq)
	queue := make(chan Job, 100)
	resultChan := make(chan Job, 100)

	ww := new(sync.WaitGroup)
	for i:=0; i<workerNum; i++ {
		ww.Add(1)
		go worker(ww, queue, resultChan)
	}

	fmt.Println("worker all up")
	time.Sleep(time.Second)

	//close(queue)
	go A(queue)

	wp := new(sync.WaitGroup)
	go func() {
		defer wp.Done()
		for res := range resultChan {
			fmt.Printf("%v ", res)
		}
	}()
	
	fmt.Println("wait for worker exit....")
	ww.Wait()
	fmt.Println("....worker exit")

	wp.Wait()
	fmt.Println("end main")
}
// -*- mode: compilation; default-directory: "~/Desktop/work/go/practice/03anti-pattern/" -*-
// Compilation started at Mon Sep 27 23:32:28
//  
// go run patn12.go
// start main
// worker all up
// wait for worker exit....
// wait all request.....
// {108 216} {109 218} {110 220} {111 222} {112 224} {113 226} {114 228} {115 230} {116 232} {117 234} {118 236} {119 238} {120 240} {121 242} {122 244} {123 246} {124 248} {125 250} {126 252} {127 254} {128 256} {129 258} {130 260} {131 262} {264 528} {265 530} {266 532} {267 534} {268 536} {269 538} {270 540} {271 542} {272 544} {273 546} {274 548} {275 550} {276 552} {277 554} {278 556} {279 558} {280 560} {281 562} {282 564} {283 566} {284 568} {285 570} {286 572} {287 574} {288 576} {289 578} {290 580} {291 582} {292 584} {293 586} {294 588} {295 590} {296 592} {132 264} {133 266} {134 268} {135 270} {136 272} {137 274} {138 276} {139 278} {140 280} {141 282} {142 284} {143 286} {144 288} {145 290} {146 292} {147 294} {148 296} {149 298} {150 300} {151 302} {152 304} {153 306} {154 308} {155 310} {156 312} {157 314} {158 316} {159 318} {160 320} {161 322} {162 324} {163 326} {164 328} {165 330} {166 332} {167 334} {168 336} {169 338} {170 340} {171 342} {172 344} {173 346} {174 348} {175 350} {176 352} {101 202} {99 198} {100 200} {104 208} {102 204} {103 206} {106 212} {105 210} {107 214} {177 354} {178 356} {179 358} {180 360} {181 362} {182 364} {183 366} {184 368} {185 370} {186 372} {187 374} {188 376} {189 378} {190 380} {191 382} {192 384} {193 386} {194 388} {195 390} {196 392} {197 394} {198 396} {199 398} {200 400} {201 402} {202 404} {203 406} {204 408} {205 410} {206 412} {207 414} {208 416} {209 418} {210 420} {211 422} {212 424} {213 426} {214 428} {215 430} {216 432} {217 434} {218 436} {219 438} {220 440} {221 442} {222 444} {223 446} {224 448} {225 450} {226 452} {227 454} {228 456} {229 458} {230 460} {231 462} {232 464} {233 466} {234 468} {235 470} {236 472} {237 474} {238 476} {239 478} {240 480} {241 482} {242 484} {243 486} {244 488} {245 490} {246 492} {247 494} {248 496} {249 498} {250 500} {251 502} {0 0} {1 2} {2 4} {3 6} {4 8} {5 10} {6 12} {7 14} {8 16} {9 18} {10 20} {11 22} {12 24} {13 26} {14 28} {15 30} {16 32} {17 34} {18 36} {19 38} {20 40} {21 42} {22 44} {23 46} {24 48} {25 50} {33 66} {66 132} {495 990} {297 594} {330 660} {363 726} {396 792} {429 858} {462 924} {627 1254} {528 1056} {561 1122} {594 1188} {693 1386} {660 1320} {726 1452} {252 504} {858 1716} {759 1518} {792 1584} {825 1650} {924 1848} {891 1782} {957 1914} {990 1980} {26 52} {34 68} {67 134} {496 992} {298 596} {331 662} {364 728} {397 794} {430 860} {463 926} {628 1256} {529 1058} {562 1124} {595 1190} {694 1388} {661 1322} {727 1454} {253 506} {859 1718} {760 1520} {793 1586} {826 1652} {925 1850} {892 1784} {958 1916} {991 1982} {27 54} {68 136} {497 994} {299 598} {332 664} {365 730} {398 796} {431 862} {464 928} {629 1258} {530 1060} {563 1126} {596 1192} {366 732} {367 734} {368 736} {369 738} {370 740} {371 742} {372 744} {373 746} {35 70} {374 748} {375 750} {376 752} {377 754} {378 756} {379 758} {380 760} {381 762} {382 764} {383 766} {384 768} {385 770} {386 772} {387 774} {388 776} {389 778} {390 780} {391 782} {393 786} {394 788} {392 784} {395 790} {695 1390} {696 1392} {697 1394} {698 1396} {699 1398} {700 1400} {702 1404} {701 1402} {703 1406} {704 1408} {705 1410} {706 1412} {707 1414} {708 1416} {709 1418} {710 1420} {711 1422} {712 1424} {713 1426} {714 1428} {715 1430} {716 1432} {717 1434} {718 1436} {719 1438} {720 1440} {721 1442} {722 1444} {723 1446} {724 1448} {725 1450} {959 1918} {960 1920} {961 1922} {962 1924} {963 1926} {964 1928} {965 1930} {966 1932} {967 1934} {968 1936} {969 1938} {970 1940} {971 1942} {972 1944} {973 1946} {974 1948} {662 1324} {728 1456} {254 508} {860 1720} {992 1984} {28 56} {36 72} {69 138} {498 996} {300 600} {333 666} {761 1522} {794 1588} {827 1654} {926 1852} {893 1786} {465 930} {399 798} {432 864} {531 1062} {630 1260} {975 1950} {564 1128} {663 1326} {597 1194} {729 1458} {255 510} {861 1722} {29 58} {37 74} {993 1986} {70 140} {499 998} {301 602} {762 1524} {795 1590} {828 1656} {927 1854} {894 1788} {466 932} {400 800} {433 866} {532 1064} {631 1262} {976 1952} {565 1130} {664 1328} {598 1196} {730 1460} {256 512} {862 1724} {30 60} {38 76} {994 1988} {500 1000} {334 668} {71 142} {796 1592} {829 1658} {895 1790} {302 604} {763 1526} {928 1856} {467 934} {401 802} {434 868} {533 1066} {632 1264} {977 1954} {566 1132} {665 1330} {599 1198} {731 1462} {863 1726} {31 62} {257 514} {39 78} {995 1990} {501 1002} {335 670} {72 144} {797 1594} {830 1660} {303 606} {896 1792} {929 1858} {764 1528} {468 936} {402 804} {435 870} {534 1068} {633 1266} {978 1956} {567 1134} {666 1332} {32 64} {258 516} {600 1200} {732 1464} {864 1728} {996 1992} {502 1004} {336 672} {73 146} {798 1596} {831 1662} {304 608} {897 1794} {765 1530} {930 1860} {469 938} {403 806} {436 872} {40 80} {535 1070} {634 1268} {979 1958} {568 1136} {667 1334} {259 518} {601 1202} {733 1466} {865 1730} {997 1994} {503 1006} {337 674} {74 148} {799 1598} {832 1664} {305 610} {898 1796} {766 1532} {931 1862} {470 940} {404 808} {437 874} {569 1138} {41 82} {536 1072} {635 1270} {980 1960} {668 1336} {260 520} {602 1204} {734 1468} {866 1732} {998 1996} {504 1008} {338 676} {75 150} {800 1600} {833 1666} {306 612} {899 1798} {767 1534} {932 1864} {471 942} {405 810} {438 876} {570 1140} {42 84} {537 1074} {636 1272} {981 1962} {669 1338} {261 522} {603 1206} {735 1470} {867 1734} {505 1010} {339 678} {76 152} {801 1602} {834 1668} {307 614} {900 1800} {768 1536} {933 1866} {472 944} {406 812} {439 878} {571 1142} {43 86} {538 1076} {637 1274} {982 1964} {670 1340} {262 524} {604 1208} {736 1472} {868 1736} {506 1012} {340 680} {77 154} {802 1604} {835 1670} {308 616} {901 1802} {934 1868} {473 946} {407 814} {440 880} {769 1538} {44 88} {539 1078} {638 1276} {671 1342} {263 526} {605 1210} {983 1966} {737 1474} {869 1738} {572 1144} {507 1014} {341 682} {803 1606} {78 156} {836 1672} {309 618} {902 1804} {935 1870} {474 948} {408 816} {441 882} {770 1540} {45 90} {540 1080} {639 1278} {672 1344} {606 1212} {984 1968} {738 1476} {870 1740} {573 1146} {508 1016} {342 684} {804 1608} {79 158} {837 1674} {310 620} {903 1806} {936 1872} {475 950} {409 818} {442 884} {771 1542} {46 92} {541 1082} {640 1280} {673 1346} {607 1214} {985 1970} {739 1478} {871 1742} {574 1148} {509 1018} {343 686} {805 1610} {80 160} {838 1676} {311 622} {904 1808} {937 1874} {476 952} {410 820} {443 886} {772 1544} {47 94} {542 1084} {641 1282} {674 1348} {608 1216} {986 1972} {740 1480} {872 1744} {575 1150} {510 1020} {344 688} {806 1612} {81 162} {839 1678} {312 624} {905 1810} {938 1876} {477 954} {411 822} {444 888} {773 1546} {48 96} {543 1086} {642 1284} {675 1350} {609 1218} {987 1974} {741 1482} {873 1746} {576 1152} {511 1022} {345 690} {807 1614} {82 164} {840 1680} {313 626} {906 1812} {939 1878} {478 956} {412 824} {445 890} {774 1548} {49 98} {544 1088} {643 1286} {676 1352} {610 1220} {988 1976} {742 1484} {874 1748} {577 1154} {512 1024} {346 692} {808 1616} {83 166} {841 1682} {314 628} {907 1814} {940 1880} {479 958} {413 826} {446 892} {775 1550} {50 100} {545 1090} {677 1354} {611 1222} {989 1978} {644 1288} {743 1486} {875 1750} {578 1156} {513 1026} {347 694} {809 1618} {84 168} {842 1684} {908 1816} {315 630} {941 1882} {776 1552} {414 828} {480 960} {51 102} {546 1092} {678 1356} {612 1224} {645 1290} {744 1488} {579 1158} {876 1752} {514 1028} {348 696} {810 1620} {85 170} {843 1686} {909 1818} {316 632} {942 1884} {481 962} {447 894} {448 896} {777 1554} {415 830} {52 104} {547 1094} {679 1358} {613 1226} {646 1292} {745 1490} {580 1160} {877 1754} {349 698} {515 1030} {811 1622} {86 172} {844 1688} {910 1820} {317 634} {943 1886} {449 898} {482 964} {778 1556} {416 832} {53 106} {680 1360} {614 1228} {548 1096} {845 1690} {911 1822} {647 1294} {746 1492} {581 1162} {878 1756} {350 700} {516 1032} {944 1888} {318 636} {812 1624} {483 966} {450 900} {417 834} {615 1230} {779 1558} {87 174} {54 108} {681 1362} {549 1098} {846 1692} {912 1824} {648 1296} {747 1494} {582 1164} {879 1758} {351 702} {517 1034} {945 1890} {319 638} {813 1626} {88 176} {484 968} {451 902} {418 836} {616 1232} {780 1560} {55 110} {682 1364} {847 1694} {913 1826} {649 1298} {550 1100} {748 1496} {583 1166} {880 1760} {352 704} ......all request done
// {518 1036} {946 1892} {320 640} {814 1628} {89 178} {485 970} {452 904} {419 838} {617 1234} {781 1562} {56 112} {683 1366} {848 1696} {914 1828} {551 1102} {749 1498} {650 1300} {584 1168} {881 1762} {353 706} {519 1038} {947 1894} {321 642} {815 1630} {90 180} {420 840} {618 1236} {915 1830} {486 972} {782 1564} {57 114} {684 1368} {849 1698} {552 1104} {750 1500} {651 1302} {585 1170} {882 1764} {354 708} {520 1040} {948 1896} {322 644} {816 1632} {91 182} {421 842} {453 906} {619 1238} {916 1832} {487 974} {783 1566} {58 116} {685 1370} {850 1700} {553 1106} {652 1304} {586 1172} {355 710} {883 1766} {521 1042} {949 1898} {323 646} {751 1502} {817 1634} {92 184} {422 844} {454 908} {620 1240} {917 1834} {488 976} {59 118} {686 1372} {784 1568} {851 1702} {554 1108} {653 1306} {587 1174} {356 712} {884 1768} {522 1044} {950 1900} {324 648} {752 1504} {818 1636} {93 186} {455 910} {621 1242} {918 1836} {489 978} {60 120} {423 846} {687 1374} {785 1570} {852 1704} {555 1110} {588 1176} {654 1308} {885 1770} {357 714} {523 1046} {951 1902} {325 650} {753 1506} {819 1638} {94 188} {622 1244} {919 1838} {456 912} {490 980} {61 122} {424 848} {688 1376} ....worker exit
// end main
//  
// Compilation finished at Mon Sep 27 23:32:30
